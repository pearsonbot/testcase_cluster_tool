# 测试用例步骤聚类分析工具 - 需求文档 V1

## 1. 项目概述

### 1.1 目标
开发一个测试用例步骤聚类分析工具，能够从 xlsx 文件导入测试用例，对所有用例的测试步骤进行语义聚类，将相近的步骤归类，并支持按用例标题或编号查询，展示用例详情及聚类重组后的步骤。

### 1.2 运行环境
- 平台：Windows
- 部署方式：解压即用（单个 exe 或免安装目录），不需要用户额外安装 Python 或任何依赖

---

## 2. 数据格式

### 2.1 输入文件格式（xlsx）

xlsx 文件中可能包含任意数量的列，程序需要**自动识别**以下核心字段（通过表头名称匹配）：

| 字段名 | 必需 | 说明 |
|--------|------|------|
| 标识   | 是   | 用例编号，如 `RAN-10224`，同一用例仅首行填写 |
| 标题   | 是   | 用例标题，同一用例仅首行填写 |
| TC步骤 | 是   | 步骤序号（1, 2, 3...） |
| TC操作 | 是   | 步骤的具体操作描述 |
| 其他列 | 否   | xlsx 中的其他列一并导入存储，用户可在界面上选择是否展示 |

**列识别规则：**
- 程序读取 xlsx 第一行作为表头
- 通过表头文本匹配核心字段（支持模糊匹配，如「标识」「用例标识」「编号」等均可识别）
- 无法自动识别时，弹出界面让用户手动指定列与字段的对应关系
- 非核心字段的列作为附加属性导入，供用户按需展示

### 2.2 数据特点
- 一条用例占多行，标识/标题等仅在首行出现，后续行为空（合并单元格或留空）
- 每条用例包含若干条步骤（步骤数不固定）
- 不同用例之间的步骤可能完全相同或语义相近
- 预计用例数量：1000+ 条

---

## 3. 功能需求

### 3.1 数据导入

| 编号 | 功能 | 描述 |
|------|------|------|
| F-01 | xlsx 文件导入 | 用户选择本地 xlsx 文件，程序自动识别列映射并解析加载全部测试用例 |
| F-02 | 列映射确认 | 自动识别列映射后展示给用户确认；无法识别时让用户手动选择 |
| F-03 | 数据校验 | 导入时校验格式，对空行、缺失字段等给出提示 |
| F-04 | 导入进度 | 显示导入进度（用例数量、步骤总数） |
| F-05 | 增量导入 | 一次导入一个文件，但保留之前已导入的数据；若新文件中的用例标识与已有数据重复，则新数据**覆盖**旧数据 |

### 3.2 步骤聚类分析

| 编号 | 功能 | 描述 |
|------|------|------|
| F-06 | 文本预处理 | 对步骤文本进行清洗：去除多余空白、统一标点等 |
| F-07 | 语义向量化 | 将每条步骤转为语义向量，默认使用 **text2vec-base-chinese** 模型 |
| F-08 | 模型可切换 | 支持切换语义模型：(1) 内置离线模型（默认 text2vec-base-chinese）(2) 用户指定本地模型路径 (3) 在线 API（用户配置 API 地址和 Key） |
| F-09 | 聚类算法 | 基于语义向量，使用聚类算法（默认 DBSCAN）将相近步骤归类 |
| F-10 | 聚类参数可调 | 用户可调整相似度阈值（控制聚类的松紧程度） |
| F-11 | 聚类结果概览 | 展示聚类结果统计：共产生多少个簇，每个簇包含多少条步骤 |
| F-12 | 簇标签自动提取 | 自动从每个簇内步骤中提取最具代表性的文本作为簇标签 |

### 3.3 用例查询与展示

| 编号 | 功能 | 描述 |
|------|------|------|
| F-13 | 按编号查询 | 输入用例编号（如 `RAN-10224`），精确匹配 |
| F-14 | 按标题查询 | 输入关键词，模糊匹配用例标题 |
| F-15 | 用例详情展示 | **默认展示**：标识、标题、TC操作；**可选展示**：xlsx 中的其他列（用户通过界面勾选） |
| F-16 | 聚类重组步骤 | 在用例详情中，对该用例的每条步骤标注所属的聚类簇编号和簇标签，并展示同簇的其他相似步骤（来自其他用例） |

### 3.4 聚类结果浏览

| 编号 | 功能 | 描述 |
|------|------|------|
| F-17 | 簇列表浏览 | 展示所有聚类簇的列表，每个簇显示代表性步骤文本（自动提取的标签）和步骤数量 |
| F-18 | 簇详情查看 | 点击某个簇，展示该簇下所有步骤及其所属用例 |

### 3.5 聚类结果导出

| 编号 | 功能 | 描述 |
|------|------|------|
| F-19 | 导出到目录 | 用户指定导出目录，将聚类结果导出为文件 |
| F-20 | 导出内容 | 导出文件包含：(1) 聚类总览表（簇编号、簇标签、步骤数量）(2) 各簇详情（簇内所有步骤及所属用例）(3) 用例级聚类视图（每条用例的步骤及其所属簇） |
| F-21 | 导出格式 | 默认导出为 xlsx 格式 |

### 3.6 日志记录

| 编号 | 功能 | 描述 |
|------|------|------|
| F-22 | 维测日志 | 程序运行时产生的所有日志保存到程序目录下的 `log/` 目录中 |
| F-23 | 日志滚动 | 按日期滚动生成日志文件（如 `log/app_2025-01-15.log`），避免单文件过大 |
| F-24 | 日志级别 | 记录 DEBUG/INFO/WARNING/ERROR 各级别日志，包括：导入解析过程、聚类计算过程、用户操作、异常信息等 |

---

## 4. 技术方案

### 4.1 技术栈

| 组件 | 选型 | 说明 |
|------|------|------|
| 开发语言 | Python 3.10+ | 生态丰富，聚类/NLP 库齐全 |
| xlsx 解析 | openpyxl | 读取 xlsx 文件，支持合并单元格处理 |
| 语义模型（默认） | text2vec-base-chinese | 轻量中文语义模型，约 400MB，本地离线推理 |
| 向量化框架 | sentence-transformers | 加载和使用语义模型 |
| 聚类算法 | scikit-learn（DBSCAN） | 不需要预设簇数量，适合此场景 |
| 用户界面 | Flask + 浏览器 | 启动本地 Web 服务，用户通过浏览器操作 |
| 数据持久化 | SQLite | 存储已导入的用例数据和聚类结果，支持增量导入和覆盖 |
| 日志框架 | Python logging + TimedRotatingFileHandler | 按日期滚动记录日志到 log/ 目录 |
| 打包分发 | PyInstaller | 打包为 Windows 可执行文件，解压即用 |

### 4.2 语义模型架构

```
                    ┌─────────────────────┐
                    │    模型适配层        │
                    │  (统一接口抽象)      │
                    └─────┬───────────────┘
                          │
           ┌──────────────┼──────────────┐
           │              │              │
    ┌──────▼──────┐ ┌────▼──────┐ ┌────▼──────────┐
    │ 内置离线模型 │ │自定义本地 │ │  在线 API     │
    │ text2vec-   │ │模型路径   │ │ (用户配置     │
    │ base-chinese│ │           │ │  地址+Key)    │
    │ (默认)      │ │           │ │               │
    └─────────────┘ └───────────┘ └───────────────┘
```

**模型切换方式：**
- 在界面「设置」中切换模型来源
- 切换后需要重新执行聚类分析
- 在线 API 模式下用户需填写：API 地址、API Key、模型名称

### 4.3 聚类方案详细说明

```
原始步骤文本
    ↓
文本预处理（去空白、统一标点）
    ↓
语义模型 Embedding（可切换模型）
    ↓
语义向量（每条步骤 → N维向量）
    ↓
计算余弦相似度矩阵
    ↓
DBSCAN 聚类（eps 由相似度阈值转换，min_samples=2）
    ↓
聚类结果：每条步骤 → 簇ID
    ↓
自动提取簇标签（取簇内最接近质心的步骤文本）
```

**相似度阈值说明：**
- 默认阈值：0.80（即余弦相似度 >= 0.80 的步骤视为同类）
- 用户可在 0.5 ~ 0.95 之间调整
- 阈值越高，聚类越严格（只有非常相似的才归一类）
- 阈值越低，聚类越宽松（语义稍有关联就归一类）

### 4.4 数据持久化方案

使用 SQLite 存储数据，数据库文件位于程序目录下的 `data/testcase.db`：

```
┌─────────────┐     ┌──────────────┐     ┌────────────────┐
│ test_cases   │────│ test_steps    │     │ cluster_results │
│              │     │              │     │                │
│ id (标识)    │     │ case_id (FK) │     │ step_id (FK)   │
│ title (标题) │     │ step_no      │     │ cluster_id     │
│ path (路径)  │     │ operation    │     │ similarity     │
│ extra_fields │     │              │     │ threshold      │
│ (JSON)       │     │              │     │                │
└─────────────┘     └──────────────┘     └────────────────┘
```

**增量导入策略：**
- 以「标识」字段作为用例的唯一键
- 新导入数据中的标识若已存在，则整条用例（含所有步骤）被新数据覆盖
- 新导入数据中的标识若不存在，则作为新用例插入
- 覆盖后需重新执行聚类分析（或提示用户手动触发）

### 4.5 用户界面方案

采用 **本地 Web 服务 + 浏览器** 方案：
- 启动 exe 后自动开启本地 HTTP 服务（如 `http://localhost:5000`）
- 自动打开默认浏览器
- 界面使用 HTML/CSS/JS 实现

**界面布局：**

```
┌──────────────────────────────────────────────────────────┐
│  测试用例步骤聚类分析工具                    [设置]       │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  [导入xlsx文件]  导入状态: 已导入1024条用例(共5120步骤)  │
│  数据库中已有用例总数: 2048 条                            │
│                                                          │
│  语义模型: text2vec-base-chinese (内置)                   │
│  相似度阈值: [====*=====] 0.80  [执行聚类]               │
│  聚类状态: 共产生 156 个簇                               │
│                                                          │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  查询: [________________________] [搜索]                 │
│  查询方式: ( ) 按编号  ( ) 按标题                         │
│                                                          │
│  展示列: [v]标识  [v]标题  [v]TC操作                     │
│         [ ]路径  [ ]预期结果  [ ]优先级  [ ]...(其他列)   │
│                                                          │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ┌────────────────────────────────────────────────────┐  │
│  │ 编号: RAN-10224                                    │  │
│  │ 标题: 基站频率同步测试                              │  │
│  │                                                    │  │
│  │ 原始步骤:                                          │  │
│  │  1. 第一步操作                                      │  │
│  │  2. 第二步操作                                      │  │
│  │  3. 第三步操作                                      │  │
│  │                                                    │  │
│  │ 聚类重组视图:                                       │  │
│  │  步骤1 -> 簇 #12「配置基站参数」                    │  │
│  │    同簇步骤:                                        │  │
│  │    - RAN-10228 步骤1: 第一步操作                    │  │
│  │    - RAN-10350 步骤3: 类似操作xxx                   │  │
│  │  步骤2 -> 簇 #7 「启动同步流程」                    │  │
│  │    同簇步骤:                                        │  │
│  │    - RAN-10229 步骤2: 第二步操作                    │  │
│  │  步骤3 -> 独立步骤（未归入任何簇）                   │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
│  [聚类总览]  [导出聚类结果]                               │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

**设置页面（模型切换）：**

```
┌──────────────────────────────────────────────────────────┐
│  设置                                                    │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  语义模型选择:                                            │
│  (*) 内置离线模型 (text2vec-base-chinese)                 │
│  ( ) 自定义本地模型                                       │
│      模型路径: [________________________] [浏览]          │
│  ( ) 在线 API                                            │
│      API 地址: [________________________]                 │
│      API Key:  [________________________]                 │
│      模型名称: [________________________]                 │
│                                                          │
│  [保存设置]                                               │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## 5. 导出格式

### 5.1 导出文件结构

用户指定导出目录后，生成以下文件：

```
导出目录/
├── 聚类总览.xlsx          # Sheet1: 簇列表（簇ID、簇标签、步骤数量）
├── 簇详情.xlsx            # 每个簇一个 Sheet，包含簇内所有步骤及所属用例
└── 用例聚类视图.xlsx      # 每条用例的步骤及其所属簇编号和簇标签
```

### 5.2 各文件内容

**聚类总览.xlsx：**

| 簇编号 | 簇标签 | 步骤数量 | 涉及用例数 |
|--------|--------|----------|-----------|
| 1 | 配置基站参数 | 35 | 28 |
| 2 | 启动同步流程 | 22 | 20 |
| ... | ... | ... | ... |

**用例聚类视图.xlsx：**

| 用例标识 | 用例标题 | 步骤号 | 步骤操作 | 簇编号 | 簇标签 |
|----------|---------|--------|----------|--------|--------|
| RAN-10224 | 基站频率同步测试 | 1 | 第一步操作 | 12 | 配置基站参数 |
| RAN-10224 | 基站频率同步测试 | 2 | 第二步操作 | 7 | 启动同步流程 |
| ... | ... | ... | ... | ... | ... |

---

## 6. 打包与分发

### 6.1 打包方案
- 使用 PyInstaller 将 Python 程序 + 依赖 + 语义模型打包
- 产出为一个目录（包含 exe 和依赖文件），压缩为 zip
- 用户解压 zip 后双击 exe 即可使用

### 6.2 目录结构

```
testcase_cluster_tool/
├── app.exe                # 主程序
├── data/                  # 数据目录（运行时自动创建）
│   └── testcase.db        # SQLite 数据库
├── log/                   # 日志目录（运行时自动创建）
│   ├── app_2025-01-15.log
│   └── app_2025-01-16.log
├── models/                # 内置模型目录
│   └── text2vec-base-chinese/
└── _internal/             # PyInstaller 依赖目录
```

### 6.3 预估大小
- 语义模型 text2vec-base-chinese：~400MB
- Python 运行时 + 依赖库：~200MB
- 总计打包后：约 **500MB - 700MB**（压缩后约 300-500MB）

---

## 7. 日志规范

### 7.1 日志目录
- 位置：程序目录下的 `log/` 子目录
- 自动创建，无需用户手动建

### 7.2 日志文件命名
- 格式：`app_YYYY-MM-DD.log`
- 按天滚动，每天一个新文件

### 7.3 日志内容
记录以下关键信息：

| 级别 | 内容示例 |
|------|---------|
| INFO | 程序启动/关闭、文件导入成功（用例数/步骤数）、聚类执行完成（簇数量）、用户查询操作 |
| WARNING | 导入时跳过的异常行、列映射模糊匹配提示 |
| ERROR | 文件解析失败、模型加载失败、聚类计算异常 |
| DEBUG | 详细的解析过程、向量化进度、聚类中间结果 |

### 7.4 日志格式
```
[2025-01-15 14:30:22] [INFO] [import] 成功导入文件: test.xlsx, 用例数: 1024, 步骤数: 5120
[2025-01-15 14:31:05] [ERROR] [cluster] 模型加载失败: FileNotFoundError: models/text2vec-base-chinese
```

---

## 8. 版本规划

### V1.0（首版目标）
- [x] xlsx 文件导入与自动列识别
- [x] 增量导入（标识重复时覆盖）
- [x] 基于 text2vec-base-chinese 的步骤语义聚类
- [x] 模型可切换（内置离线 / 自定义本地 / 在线API）
- [x] 相似度阈值可调
- [x] 簇标签自动提取
- [x] 按编号/标题查询用例
- [x] 用例详情展示（默认展示标识+标题+TC操作，其他列可选）
- [x] 聚类重组视图
- [x] 聚类结果总览与簇详情
- [x] 聚类结果导出到指定目录（xlsx 格式）
- [x] 维测日志记录到 log/ 目录
- [x] Windows 免安装打包（PyInstaller）

### V1.1（后续可选）
- 簇标签可编辑
- 聚类结果缓存（避免重复计算）
- 用例对比功能（选择两条用例，对比步骤异同）
- 批量查询与筛选
