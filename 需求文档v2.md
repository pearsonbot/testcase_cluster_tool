# 测试用例步骤聚类分析工具 - 需求文档 V2（增量功能）

基于 V1 版本，新增以下功能需求。

---

## 1. 数据管理 - 支持删除操作

### 1.1 背景
V1 仅支持导入（新增/覆盖），用户无法删除已导入的数据。当导入了错误文件或不再需要某些用例时，缺少清理手段。

### 1.2 功能需求

| 编号 | 功能 | 描述 |
|------|------|------|
| F-25 | 单条用例删除 | 在用例详情页或搜索结果列表中，提供「删除」按钮，删除选中的单条用例及其所有步骤 |
| F-26 | 批量删除 | 在用例列表中支持多选（勾选框），批量删除选中的用例 |
| F-27 | 按来源文件删除 | 提供「按导入文件删除」功能，选择某次导入的源文件名，删除该文件导入的所有用例 |
| F-28 | 清空全部数据 | 提供「清空数据库」按钮，一键删除所有用例、步骤及聚类结果 |
| F-29 | 删除确认 | 所有删除操作均需二次确认弹窗，显示将要删除的用例数量，防止误操作 |
| F-30 | 级联清理 | 删除用例时，自动级联删除关联的步骤数据和聚类结果；删除后若聚类结果部分失效，界面提示用户重新执行聚类 |

### 1.3 界面设计

```
┌─────────────────────────────────────────────────────────────┐
│  数据管理                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  数据库状态: 2048 条用例, 10240 条步骤                        │
│                                                              │
│  按来源文件删除:                                              │
│  ┌──────────────────────────────────┐                        │
│  │ [v] test_cases_batch1.xlsx (512条) │  [删除选中文件的数据]  │
│  │ [ ] test_cases_batch2.xlsx (1536条)│                      │
│  └──────────────────────────────────┘                        │
│                                                              │
│  [清空全部数据]                                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

搜索结果列表中每行增加勾选框和删除按钮：

```
  [ ] RAN-10224  基站频率同步测试  3步骤  [查看] [删除]
  [ ] RAN-10225  基站功率配置测试  4步骤  [查看] [删除]
  [批量删除选中]
```

### 1.4 接口设计

| 方法 | 路径 | 说明 |
|------|------|------|
| DELETE | `/api/cases/<case_id>` | 删除单条用例 |
| POST | `/api/cases/batch-delete` | 批量删除，body: `{ "case_ids": [...] }` |
| DELETE | `/api/import/by-source/<filename>` | 删除指定源文件导入的所有用例 |
| DELETE | `/api/cases/all` | 清空全部数据 |
| GET | `/api/import/sources` | 获取所有已导入的源文件列表及各文件用例数 |

---

## 2. 数据浏览 - 全量查看数据库内容

### 2.1 背景
V1 必须输入关键词才能查询用例，用户无法直观浏览数据库中已有的全部数据。

### 2.2 功能需求

| 编号 | 功能 | 描述 |
|------|------|------|
| F-31 | 全量用例列表 | 新增「数据浏览」页面（或在主页增加入口），以分页表格形式展示数据库中所有用例，默认每页 20 条 |
| F-32 | 分页与排序 | 支持翻页（上一页/下一页/跳转页码），支持按标识、标题、步骤数、导入时间排序 |
| F-33 | 快捷筛选 | 列表顶部提供筛选条件：按来源文件下拉筛选，按标题关键词实时过滤 |
| F-34 | 步骤预览 | 在用例列表中点击展开行，直接预览该用例的步骤列表，无需跳转详情页 |
| F-35 | 数据统计栏 | 页面顶部显示统计信息：用例总数、步骤总数、来源文件数、最近导入时间 |

### 2.3 界面设计

```
┌──────────────────────────────────────────────────────────────┐
│  数据浏览                                                     │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  用例总数: 2048  |  步骤总数: 10240  |  来源文件: 3个          │
│                                                               │
│  筛选: 来源文件 [全部 v]  关键词 [__________]                  │
│                                                               │
│  ┌────┬──────────┬──────────────────┬──────┬─────────┬─────┐ │
│  │ [] │ 标识      │ 标题              │ 步骤数│ 来源文件 │ 操作│ │
│  ├────┼──────────┼──────────────────┼──────┼─────────┼─────┤ │
│  │ [] │RAN-10224 │基站频率同步测试    │  3   │batch1   │[v][ ]│ │
│  │    │  ├ 1. 配置基站参数...        │      │         │     │ │
│  │    │  ├ 2. 启动同步流程...        │      │         │     │ │
│  │    │  └ 3. 检查同步状态...        │      │         │     │ │
│  │ [] │RAN-10225 │基站功率配置测试    │  4   │batch1   │[v][ ]│ │
│  │ ...│          │                  │      │         │     │ │
│  └────┴──────────┴──────────────────┴──────┴─────────┴─────┘ │
│                                                               │
│  共 2048 条  第 1/103 页  [上一页] [1] [2] [3]...[下一页]      │
│  [批量删除选中]                                                │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 2.4 接口设计

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/cases/browse?page=1&per_page=20&sort=id&order=asc&source=&keyword=` | 分页浏览全部用例 |
| GET | `/api/import/sources` | 获取来源文件列表（同上复用） |

---

## 3. 聚类进度条与详细日志

### 3.1 背景
V1 聚类执行期间只显示粗略的阶段文字（如"Computing embeddings..."），缺少百分比进度和耗时预估。日志中也缺少 API 调用或模型推理的详细信息，排查问题困难。

### 3.2 功能需求

| 编号 | 功能 | 描述 |
|------|------|------|
| F-36 | 百分比进度条 | 聚类执行期间，在界面上显示带百分比的进度条，分阶段汇报进度 |
| F-37 | 分阶段进度 | 将聚类流程分为 5 个阶段，每个阶段独立计算进度并显示阶段名称：① 文本预处理 ② 模型加载 ③ 向量计算 ④ 聚类计算 ⑤ 结果保存 |
| F-38 | 向量计算批次进度 | 向量计算阶段（耗时最长）需按批次更新进度，如"向量计算: 1500/5000 (30%)" |
| F-39 | 已用时间显示 | 进度条旁边显示已用时间（如"已用时: 2分30秒"） |
| F-40 | 详细日志 - API 调用 | 使用在线 API 模式时，日志记录：每次 API 请求的 URL、batch 大小、响应时间、返回的向量维度、累计 token 用量（如 API 返回该字段）、错误重试次数及原因 |
| F-41 | 详细日志 - 本地模型 | 使用本地离线模型时，日志记录：模型加载路径、加载耗时、每个 batch 的推理耗时、GPU/CPU 设备信息、内存占用 |
| F-42 | 详细日志 - 聚类过程 | 记录：距离矩阵计算耗时、DBSCAN 参数(eps, min_samples)、聚类耗时、各簇步骤数分布、噪声点数量 |

### 3.3 进度数据结构

```json
{
  "status": "running",
  "phase": "embedding",
  "phase_name": "向量计算",
  "phase_index": 3,
  "total_phases": 5,
  "phase_progress": 30,
  "overall_progress": 45,
  "detail": "向量计算: 1500/5000",
  "elapsed_seconds": 150,
  "error": null
}
```

### 3.4 界面设计

```
┌──────────────────────────────────────────────────────────────┐
│  聚类分析                                                     │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ③ 向量计算  (3/5)                           已用时: 2分30秒   │
│  ████████████░░░░░░░░░░░░░░░░░░ 45%                          │
│  向量计算: 1500/5000 (30%)                                    │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 3.5 日志格式示例

**API 调用日志：**
```
[2025-01-15 14:30:22] [DEBUG] [embedding_api] API request: POST https://api.openai.com/v1/embeddings, batch_size=32, texts[0]="配置基站参数..."
[2025-01-15 14:30:23] [DEBUG] [embedding_api] API response: 200 OK, time=1.2s, vectors=32, dim=1536
[2025-01-15 14:30:23] [DEBUG] [embedding_api] Progress: 64/5000 texts encoded
[2025-01-15 14:30:25] [WARNING] [embedding_api] API rate limited (429), retry 1/3, waiting 5s
[2025-01-15 14:30:30] [DEBUG] [embedding_api] Retry succeeded, time=1.5s
```

**本地模型日志：**
```
[2025-01-15 14:30:22] [INFO] [embedding_builtin] Loading model from models/text2vec-base-chinese
[2025-01-15 14:30:35] [INFO] [embedding_builtin] Model loaded in 13.2s, device=cpu, dim=768
[2025-01-15 14:30:35] [DEBUG] [embedding_builtin] Encoding batch 1/157 (batch_size=32)
[2025-01-15 14:30:36] [DEBUG] [embedding_builtin] Batch 1 encoded in 0.8s
[2025-01-15 14:30:45] [DEBUG] [embedding_builtin] Encoding batch 50/157, elapsed=10.2s, ETA=20.4s
```

**聚类过程日志：**
```
[2025-01-15 14:31:00] [INFO] [cluster_engine] Computing cosine distance matrix (5000x5000)...
[2025-01-15 14:31:02] [INFO] [cluster_engine] Distance matrix computed in 2.1s
[2025-01-15 14:31:02] [INFO] [cluster_engine] Running DBSCAN: eps=0.20, min_samples=2
[2025-01-15 14:31:05] [INFO] [cluster_engine] DBSCAN completed in 3.2s
[2025-01-15 14:31:05] [INFO] [cluster_engine] Results: 156 clusters, 320 noise steps
[2025-01-15 14:31:05] [INFO] [cluster_engine] Cluster size distribution: min=2, max=89, median=12, mean=30.0
```

---

## 4. 聚类结果主页展示与历史记录

### 4.1 背景
V1 聚类完成后，主页只显示"聚类完成: N 个簇"的简要文字，用户需要跳转到「聚类总览」页面才能看到详情。缺少历史记录功能，每次重新聚类后旧结果丢失。

### 4.2 功能需求

| 编号 | 功能 | 描述 |
|------|------|------|
| F-43 | 主页聚类结果面板 | 聚类完成后，在主页直接展示聚类结果摘要面板：簇数量、噪声步骤数、阈值，以及前 10 个簇的列表（簇标签+步骤数），点击可展开查看簇内步骤 |
| F-44 | 聚类历史记录 | 每次执行聚类时，将结果保存为一条历史记录，包含：执行时间、使用的模型、阈值、簇数量、噪声数、总步骤数 |
| F-45 | 历史记录列表 | 新增「聚类历史」页面（或在主页增加面板），列表展示所有历史聚类记录 |
| F-46 | 历史记录查看 | 点击某条历史记录，加载该次聚类的完整结果（簇列表、各簇步骤），界面与当前聚类结果展示一致 |
| F-47 | 历史记录对比 | 可选择两条历史记录进行对比，展示簇数量变化、新增/消失的簇 |
| F-48 | 历史记录删除 | 支持删除不需要的历史记录 |

### 4.3 数据库扩展

新增 `cluster_history` 表：

```sql
CREATE TABLE cluster_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    run_time TEXT NOT NULL,            -- 执行时间 (ISO格式)
    model_type TEXT,                   -- 使用的模型类型
    model_name TEXT,                   -- 模型名称
    similarity_threshold REAL,         -- 相似度阈值
    total_steps INTEGER,               -- 总步骤数
    total_clusters INTEGER,            -- 簇数量
    noise_count INTEGER,               -- 噪声步骤数
    elapsed_seconds REAL,              -- 耗时（秒）
    is_current INTEGER DEFAULT 0       -- 是否为当前活跃结果 (1=是)
);
```

修改 `cluster_results` 表，增加 `history_id` 外键：

```sql
ALTER TABLE cluster_results ADD COLUMN history_id INTEGER REFERENCES cluster_history(id);
```

修改 `cluster_info` 表，增加 `history_id` 外键：

```sql
ALTER TABLE cluster_info ADD COLUMN history_id INTEGER REFERENCES cluster_history(id);
```

### 4.4 界面设计

**主页聚类结果面板（聚类完成后显示）：**

```
┌──────────────────────────────────────────────────────────────┐
│  聚类结果                                         2025-01-15  │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  模型: text2vec-base-chinese | 阈值: 0.80 | 耗时: 2分30秒    │
│  簇数量: 156 | 噪声步骤: 320 | 总步骤: 5000                   │
│                                                               │
│  TOP 10 聚类簇:                                               │
│  ┌────┬──────────────────────────────┬──────┬──────┐         │
│  │ #  │ 簇标签                        │ 步骤数│ 用例数│         │
│  ├────┼──────────────────────────────┼──────┼──────┤         │
│  │  1 │ 配置基站参数                  │  89  │  72  │         │
│  │  2 │ 启动同步流程                  │  65  │  58  │         │
│  │  3 │ 检查运行状态                  │  52  │  45  │         │
│  │ ...│ ...                          │ ...  │ ...  │         │
│  └────┴──────────────────────────────┴──────┴──────┘         │
│                                                               │
│  [查看完整聚类总览]  [查看历史记录]                             │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

**聚类历史页面：**

```
┌──────────────────────────────────────────────────────────────┐
│  聚类历史记录                                                  │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────┬─────────────┬──────────────┬──────┬─────┬─────┬────┐│
│  │ #  │ 执行时间     │ 模型          │ 阈值  │ 簇数 │ 噪声 │ 操作││
│  ├────┼─────────────┼──────────────┼──────┼─────┼─────┼────┤│
│  │  1 │01-15 14:30  │text2vec(内置) │ 0.80 │ 156 │ 320 │[查看]││
│  │  2 │01-14 10:00  │text2vec(内置) │ 0.75 │ 120 │ 450 │[查看]││
│  │  3 │01-13 16:20  │API:text-3    │ 0.85 │ 200 │ 180 │[查看]││
│  └────┴─────────────┴──────────────┴──────┴─────┴─────┴────┘│
│                                                               │
│  [★] 当前活跃   [删除选中]                                     │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 4.5 接口设计

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/cluster/history` | 获取所有聚类历史记录列表 |
| GET | `/api/cluster/history/<id>` | 获取某条历史记录的详情（含簇列表） |
| DELETE | `/api/cluster/history/<id>` | 删除某条历史记录 |
| POST | `/api/cluster/history/<id>/activate` | 将某条历史记录设为当前活跃结果 |
| GET | `/api/cluster/current-summary` | 获取当前活跃聚类的摘要（用于主页面板） |

---

## 5. 前端 UI 中文化

### 5.1 背景
V1 前端界面的标题、按钮、标签、提示等大量使用英文，与目标用户群（中文用户）不匹配。

### 5.2 功能需求

| 编号 | 功能 | 描述 |
|------|------|------|
| F-49 | 全界面中文化 | 将所有界面文本从英文替换为中文，包括：导航栏、页面标题、按钮文字、表单标签、表头、提示信息、错误信息、空状态文案 |

### 5.3 翻译对照表

**导航栏：**

| 英文 | 中文 |
|------|------|
| Home | 首页 |
| Cluster Overview | 聚类总览 |
| Settings | 设置 |

**导入区域：**

| 英文 | 中文 |
|------|------|
| Data Import | 数据导入 |
| Import xlsx | 导入 xlsx 文件 |
| Column Mapping Confirmation | 列映射确认 |
| Confirm Import | 确认导入 |
| Cancel | 取消 |
| Database: X cases, Y steps | 数据库: X 条用例, Y 条步骤 |
| No data imported yet | 暂无导入数据 |
| Last import: ... | 上次导入: ... |
| Successfully imported X cases with Y steps | 成功导入 X 条用例, Y 条步骤 |
| Field | 字段 |
| Mapped Column | 映射列 |
| Not Mapped | 未映射 |
| -- Select Column -- | -- 请选择列 -- |
| Extra columns: | 附加列: |

**聚类区域：**

| 英文 | 中文 |
|------|------|
| Clustering | 聚类分析 |
| Model: | 模型: |
| Similarity Threshold: | 相似度阈值: |
| Run Clustering | 执行聚类 |
| Clustering completed | 聚类完成 |
| X clusters, Y independent steps | X 个簇, Y 个独立步骤 |
| Not yet run | 未执行 |

**搜索区域：**

| 英文 | 中文 |
|------|------|
| Search Test Cases | 搜索测试用例 |
| Search keyword... | 搜索关键词... |
| By Title | 按标题 |
| By ID | 按编号 |
| Search | 搜索 |
| Extra columns: | 附加列: |
| Search Results | 搜索结果 |
| No results found | 未找到匹配结果 |

**用例详情：**

| 英文 | 中文 |
|------|------|
| Case Detail | 用例详情 |
| Close | 关闭 |
| Original Steps | 原始步骤 |
| Cluster View | 聚类视图 |
| Cluster #X | 簇 #X |
| Independent | 独立步骤 |
| Similar steps in other cases: | 其他用例中的相似步骤: |
| Source: | 来源文件: |
| Imported: | 导入时间: |

**聚类总览页：**

| 英文 | 中文 |
|------|------|
| Cluster Overview | 聚类总览 |
| Export | 导出 |
| Cluster ID | 簇编号 |
| Label | 簇标签 |
| Steps | 步骤数 |
| Cases | 用例数 |
| Action | 操作 |
| View Detail | 查看详情 |
| No clustering results yet... | 暂无聚类结果... |
| X clusters covering Y steps | X 个簇, 覆盖 Y 条步骤 |

**簇详情页：**

| 英文 | 中文 |
|------|------|
| Cluster Detail | 簇详情 |
| Clusters | 聚类总览 |
| Step Operation | 步骤操作 |
| Case ID | 用例标识 |
| Case Title | 用例标题 |
| Step # | 步骤号 |

**设置页：**

| 英文 | 中文 |
|------|------|
| Model Settings | 模型设置 |
| Embedding Model Source | 语义模型来源 |
| Built-in Offline Model | 内置离线模型 |
| Custom Local Model | 自定义本地模型 |
| Online API (OpenAI-compatible) | 在线 API (OpenAI 兼容) |
| TF-IDF Lightweight Mode | TF-IDF 轻量模式 |
| Test Only | 仅供测试 |
| Path to local model directory | 本地模型目录路径 |
| API URL | API 地址 |
| API Key | API 密钥 |
| Model Name | 模型名称 |
| Test Connection | 测试连接 |
| Save Settings | 保存设置 |
| Settings saved successfully | 设置保存成功 |
| Model test successful | 模型测试成功 |
| Model test failed | 模型测试失败 |
| Dimension: | 向量维度: |

**操作按钮：**

| 英文 | 中文 |
|------|------|
| View All Clusters | 查看聚类总览 |
| Export Clustering Results | 导出聚类结果 |
| View | 查看 |
| Delete | 删除 |

**提示消息：**

| 英文 | 中文 |
|------|------|
| Please select an xlsx file first | 请先选择 xlsx 文件 |
| Please upload an xlsx file | 请上传 xlsx 格式文件 |
| No file uploaded. Please upload first. | 未上传文件，请先上传 |
| No clustering results to export | 无聚类结果可导出，请先执行聚类 |
| Clustering is already running | 聚类正在执行中，请勿重复操作 |
| Export completed successfully | 导出成功 |
| Cannot connect to server | 无法连接服务器 |

---

## 6. 实现优先级建议

| 优先级 | 需求 | 原因 |
|--------|------|------|
| P0 | 5. 前端 UI 中文化 | 改动独立、无依赖，可立即执行 |
| P0 | 3. 聚类进度条与详细日志 | 提升用户体验的核心痛点 |
| P1 | 4. 聚类结果主页展示与历史记录 | 需要数据库 schema 变更，需先完成再做后续 |
| P1 | 2. 数据浏览 | 新增页面和接口，相对独立 |
| P1 | 1. 数据删除 | 依赖数据浏览功能的列表界面 |

---

## 7. 数据库变更汇总

### 新增表

```sql
-- 聚类历史记录表
CREATE TABLE cluster_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    run_time TEXT NOT NULL,
    model_type TEXT,
    model_name TEXT,
    similarity_threshold REAL,
    total_steps INTEGER,
    total_clusters INTEGER,
    noise_count INTEGER,
    elapsed_seconds REAL,
    is_current INTEGER DEFAULT 0
);
```

### 修改表

```sql
-- cluster_results 增加 history_id
ALTER TABLE cluster_results ADD COLUMN history_id INTEGER REFERENCES cluster_history(id);

-- cluster_info 增加 history_id
ALTER TABLE cluster_info ADD COLUMN history_id INTEGER REFERENCES cluster_history(id);
```

### 索引

```sql
CREATE INDEX idx_cluster_results_history ON cluster_results(history_id);
CREATE INDEX idx_cluster_info_history ON cluster_info(history_id);
CREATE INDEX idx_cluster_history_current ON cluster_history(is_current);
```
